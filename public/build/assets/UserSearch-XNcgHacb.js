import{b as te,Y as ae,z as ne,f as _,g as N,aW as L,b7 as oe,aZ as se,b8 as ue,b6 as ie,_ as le,d as re,aV as de,a6 as ce,aX as pe,r as j,o as S,i as V,w as k,j as z,a as q,ab as _e,c as Y,M as me,G as ve,aY as fe,aD as he,n as xe,l as U,t as M,k as ye,aG as be}from"./app-CC-3xOuG.js";import{S as ge}from"./SupplierAddButton-B9VjJ1nj.js";import{C as Se}from"./CustomerAddButton-GMt0psx4.js";const De=()=>{const{formatAmount:a,orderType:y,orderPageObject:l,selectedWarehouse:A,dayjs:C,appSetting:c}=te(),{t:f}=ae(),g=ne(),s=_([]),v=_([]),F=_([]),r=N({orderSearchTerm:void 0,productFetching:!1,products:[]}),i=_({order_type:g.params.type,invoice_number:"",order_date:C().utc().format("YYYY-MM-DDTHH:mm:ssZ"),warehouse_id:y.value=="stock-transfers"?void 0:A.value.xid,user_id:void 0,terms_condition:A.value.terms_condition,notes:"",order_status:void 0,tax_id:void 0,tax_rate:0,tax_amount:0,discount:0,shipping:0,subtotal:0}),d=_([]),w=_({subtotal:0,tax:0}),$=_(!1),G=_(!1),m=_({}),H=_([]),B=_(""),K=L(e=>{I(e)},300),I=e=>{r.products=[],e!=""&&(r.productFetching=!0,axiosAdmin.post("search-product",{order_type:l.value.type,search_term:e,warehouse_id:i.value.warehouse_id}).then(t=>{t.data.length==1?P("",{product:t.data[0]}):r.products=t.data,r.productFetching=!1}))},Q=e=>{ie(()=>{e.keyCode==13&&I(e.target.value)})},P=(e,n)=>{const t=n.product;if(oe(v.value,t.xid)){const p=se(s.value,["xid",t.xid]);if(p&&(p.quantity<p.stock_quantity||p.product_type=="service")){const h=[];var o={};s.value.map(x=>{var b=x.quantity;x.xid==t.xid&&(b+=1,x.quantity=b,o=x),h.push(x)}),s.value=h;var u=new Audio(c.value.beep_audio_url);u.play(),r.orderSearchTerm=void 0,r.products=[],D(o)}else r.orderSearchTerm=void 0,r.products=[],ue.error(f("common.out_of_stock"))}else{v.value.push(t.xid),s.value.push({...t,sn:s.value.length+1,unit_price:a(t.unit_price),tax_amount:a(t.tax_amount),subtotal:a(t.subtotal)}),r.orderSearchTerm=void 0,r.products=[],T();var u=new Audio(c.value.beep_audio_url);u.play()}},R=e=>{var n=parseFloat(e.quantity),t=parseFloat(e.stock_quantity);e.item_id;const u=parseFloat(e.unit_price);e.product_type!="service"&&(n=n>t&&(l.value.type=="sales"||l.value.type=="purchase-returns")?t:n);const o=e.discount_rate,p=o>0?o/100*u:0,h=u-p;var O=0,x=h,b=u;return e.tax_rate>0&&(e.tax_type=="inclusive"?(b=h*100/(100+e.tax_rate),O=b*(e.tax_rate/100)):(O=h*(e.tax_rate/100),x=h+O,b=h)),{...e,total_discount:p*n,subtotal:x*n,quantity:n,total_tax:O*n,max_quantity:t,single_unit_price:b}},D=e=>{const n=[];s.value.map(t=>{if(t.xid==e.xid){const u=R(e);n.push(u)}else n.push(t)}),s.value=n,T()},T=()=>{let e=0,n=0;s.value.map(p=>{e+=p.subtotal});const t=i.value.discount!=""?parseFloat(i.value.discount):0,u=i.value.tax_rate&&i.value.tax_rate!=""?parseFloat(i.value.tax_rate):0;s.value.map(p=>{n+=p.total_tax}),w.value.subtotal=e,w.value.tax=n,e=e-t;const o=e*(u/100);e=e+parseFloat(i.value.shipping),i.value.subtotal=a(e+o),i.value.tax_amount=a(o),i.value.discount=t},W=()=>{let e=0,n=0;s.value.map(t=>{e+=t.subtotal}),s.value.map(t=>{n+=t.total_tax}),w.value.subtotal=e,w.value.tax=n},Z=e=>{const n=[];let t=1;s.value.map(o=>{e.item_id&&e.item_id!=""&&e.item_id!=null&&e.item_id==o.item_id&&o.item_id!=null&&(F.value=[...F.value,o.item_id]),o.xid!=e.xid&&(n.push({...o,sn:t,single_unit_price:a(o.single_unit_price),tax_amount:a(o.tax_amount),subtotal:a(o.subtotal)}),t++)}),s.value=n;const u=v.value.filter(o=>o!=e.xid);v.value=u,T()},X=(e,n)=>{i.value.tax_rate=e==null?0:n.tax.rate,T()},J=e=>{m.value={id:e.xid,discount_rate:e.discount_rate,unit_price:e.unit_price,tax_id:e.x_tax_id,tax_type:e.tax_type==null?void 0:e.tax_type},$.value=!0,B.value=e.name},ee=()=>{const e=s.value.filter(o=>o.xid==m.value.id),n=d.value.filter(o=>o.xid==m.value.tax_id),t=m.value.tax_type!=null?m.value.tax_type:"exclusive",u={...e[0],discount_rate:parseFloat(m.value.discount_rate),unit_price:parseFloat(m.value.unit_price),tax_id:m.value.tax_id,tax_rate:n[0]?n[0].rate:0,tax_type:t};D(u),E()},E=()=>{m.value={},$.value=!1};return{state:r,route:g,orderType:y,orderPageObject:l,selectedProducts:s,selectedProductIds:v,formData:i,productsAmount:w,taxes:d,fetchProducts:K,searchValueSelected:P,recalculateValues:R,quantityChanged:D,recalculateFinalTotal:T,showDeleteConfirm:Z,taxChanged:X,editItem:J,addEditVisible:$,addEditFormData:m,addEditFormSubmitting:G,addEditRules:H,addEditPageTitle:B,onAddEditSubmit:ee,onAddEditClose:E,removedOrderItemsIds:F,calculateProductAmount:W,inputValueChanged:Q}},Ae=re({props:["orderPageObject","rules","usersList","editOrderDisable"],emits:["onSuccess"],components:{SearchOutlined:de,SupplierAddButton:ge,CustomerAddButton:Se},setup(a,{emit:y}){const l=N({orderSearchTerm:[],productFetching:!1,products:[]}),A=L(c=>{if(l.products=[],c!=""){const f=c.trim();l.productFetching=!0;const g=`name lk "${f}%" or (phone lk "${f}%")`;let s=`${a.orderPageObject.userType}?fields=id,xid,name,phone&filters=${encodeURIComponent(g)}`;axiosAdmin.get(s).then(v=>{l.products=v.data,l.productFetching=!1})}},300),C=(c,f)=>{y("onSuccess",c)};return ce(()=>a.usersList,(c,f)=>{l.products=[c],l.orderSearchTerm=c.xid}),{...pe(l),fetchProducts:A,searchValueSelected:C}}}),Fe={style:{display:"flex"}},we={key:0},Te=z("br",null,null,-1);function ke(a,y,l,A,C,c){const f=j("SearchOutlined"),g=fe,s=be,v=he,F=j("SupplierAddButton"),r=j("CustomerAddButton"),i=xe;return S(),V(i,{label:a.$t(`${a.orderPageObject.langKey}.user`),name:"user_id",help:a.rules.user_id?a.rules.user_id.message:null,validateStatus:a.rules.user_id?"error":null,class:"required"},{default:k(()=>[z("span",Fe,[q(v,{value:a.orderSearchTerm,"onUpdate:value":y[0]||(y[0]=d=>a.orderSearchTerm=d),"show-search":"","filter-option":!1,placeholder:a.$t("common.select_default_text",[a.$t(`${a.orderPageObject.langKey}.user`)]),style:{width:"100%"},"not-found-content":a.productFetching?void 0:null,onSearch:a.fetchProducts,"option-label-prop":"label",onSelect:a.searchValueSelected,disabled:a.editOrderDisable},_e({suffixIcon:k(()=>[q(f)]),default:k(()=>[(S(!0),Y(ve,null,me(a.products,d=>(S(),V(s,{key:d.xid,value:d.xid,label:d.name,product:d},{default:k(()=>[U(M(d.name)+" ",1),d.phone&&d.phone!=""?(S(),Y("span",we,[Te,U(" "+M(d.phone),1)])):ye("",!0)]),_:2},1032,["value","label","product"]))),128))]),_:2},[a.productFetching?{name:"notFoundContent",fn:k(()=>[q(g,{size:"small"})]),key:"0"}:void 0]),1032,["value","placeholder","not-found-content","onSearch","onSelect","disabled"]),a.orderPageObject.userType=="suppliers"?(S(),V(F,{key:0})):(S(),V(r,{key:1}))])]),_:1},8,["label","help","validateStatus"])}const je=le(Ae,[["render",ke]]);export{je as U,De as s};
